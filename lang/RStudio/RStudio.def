Bootstrap: library
From: ubuntu:22.04

%environment
    LANG=en_US.UTF-8    
    LC_ALL="en_US.UTF-8"
    export LANG
    export LC_ALL

%post
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Etc/UTC
    apt update -qq
    apt install -y --no-install-recommends software-properties-common dirmngr wget locales

    wget -qO- \
         https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | \
         tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
    add-apt-repository -y "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
    apt install -y --no-install-recommends r-base r-base-dev

    wget -O /rstudio-2023.03.0-386-amd64.deb \
      https://download1.rstudio.org/electron/jammy/amd64/rstudio-2023.03.0-386-amd64.deb
    apt -y install /rstudio-2023.03.0-386-amd64.deb

    wget -O /rstudio-server-2023.03.0-386-amd64.deb \
      https://download2.rstudio.org/server/jammy/amd64/rstudio-server-2023.03.0-386-amd64.deb 
    apt install -y gdebi-core
    gdebi -n /rstudio-server-2023.03.0-386-amd64.deb

    # Log to stderr
    echo "[*]\nlog-level=error\nlogger-type=stderr\n" > /etc/rstudio/logging.conf

    # Setup the "general" CRAN repo
    echo 'local({
 r <- getOption("repos")
 r["CRAN"] = "https://cran.us.r-project.org"
 options(repos = r)
})' >> /etc/R/Rprofile.site

    # Prepare system to use UTF-8
    sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen && update-locale

    # Remove unneeded source packages
    rm -f /rstudio*.deb

%runscript
    /usr/bin/rstudio "$@"

%startscript
    /usr/lib/rstudio-server/bin/rserver --server-user=$(whoami)"$@"
